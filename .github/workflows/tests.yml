name: Tests

on:
  push:
    branches: [ master, main, develop, sprint* ]
  pull_request:
    branches: [ master, main ]

env:
  XCODE_VERSION: "26.1"

jobs:
  # Smoke test to verify app builds and launches on tvOS
  smoke-test:
    name: Smoke Test (tvOS ${{ matrix.tvos-version }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        tvos-version: ['18.5', '26']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: |
        sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
        xcodebuild -version

    - name: List available tvOS runtimes
      run: |
        echo "Available runtimes:"
        xcrun simctl list runtimes | grep -i tvos || true
        echo ""
        echo "Available devices:"
        xcrun simctl list devices available | grep -i "tv" || true

    - name: Cache SPM packages
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          .swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Find simulator
      id: find-simulator
      run: |
        TVOS_VERSION="${{ matrix.tvos-version }}"
        echo "Looking for Apple TV simulator with tvOS $TVOS_VERSION..."

        # List all available Apple TV devices
        echo "Available Apple TV simulators:"
        xcrun simctl list devices available | grep -i "apple tv" || true

        # Find the runtime identifier for the requested tvOS version
        echo "Available tvOS runtimes:"
        xcrun simctl list runtimes | grep -i tvos

        # Get the runtime ID for our target version (e.g., com.apple.CoreSimulator.SimRuntime.tvOS-18-5)
        RUNTIME_ID=$(xcrun simctl list runtimes | grep -i "tvOS $TVOS_VERSION" | grep -oE 'com\.apple\.CoreSimulator\.SimRuntime\.[^ ]+' | head -1) || true

        if [ -z "$RUNTIME_ID" ]; then
          echo "::error::tvOS $TVOS_VERSION runtime not found"
          exit 1
        fi
        echo "Found runtime: $RUNTIME_ID"

        # Get the first available Apple TV simulator for this runtime
        DEVICE_ID=$(xcrun simctl list devices available "$RUNTIME_ID" | grep -i "Apple TV" | head -1 | grep -oE '[A-F0-9-]{36}') || true

        if [ -z "$DEVICE_ID" ]; then
          echo "::error::No Apple TV simulator found for tvOS $TVOS_VERSION"
          exit 1
        fi

        echo "Found simulator: $DEVICE_ID"
        echo "DEVICE_ID=$DEVICE_ID" >> $GITHUB_OUTPUT

    - name: Boot simulator
      run: |
        DEVICE_ID="${{ steps.find-simulator.outputs.DEVICE_ID }}"
        echo "Booting simulator: $DEVICE_ID"
        xcrun simctl boot "$DEVICE_ID" || true
        sleep 15
        echo "Booted devices:"
        xcrun simctl list devices | grep -i booted || true

    - name: Build app
      run: |
        DEVICE_ID="${{ steps.find-simulator.outputs.DEVICE_ID }}"
        echo "Building app for tvOS..."
        xcodebuild build \
          -project "Internet Archive.xcodeproj" \
          -scheme "Internet Archive" \
          -destination "platform=tvOS Simulator,id=$DEVICE_ID" \
          -derivedDataPath DerivedData \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Install and launch app
      run: |
        DEVICE_ID="${{ steps.find-simulator.outputs.DEVICE_ID }}"
        APP_PATH=$(find DerivedData/Build/Products -name "Internet Archive.app" -type d | head -1)
        echo "Installing app from: $APP_PATH"
        xcrun simctl install "$DEVICE_ID" "$APP_PATH"
        echo "Launching app..."
        # Launch the app - capture output and exit code separately
        set +e
        LAUNCH_OUTPUT=$(xcrun simctl launch "$DEVICE_ID" archivetv 2>&1)
        LAUNCH_EXIT=$?
        set -e
        echo "Launch output: $LAUNCH_OUTPUT"
        echo "Launch exit code: $LAUNCH_EXIT"
        # Give the app time to start
        sleep 3
        # Check if the launch output contains a PID (format: "archivetv: 12345")
        if echo "$LAUNCH_OUTPUT" | grep -qE "archivetv: [0-9]+"; then
          echo "✅ App launched successfully"
          exit 0
        fi
        # If launch failed, check if app is installed and try to get more info
        if [ $LAUNCH_EXIT -ne 0 ]; then
          echo "Launch command failed with exit code $LAUNCH_EXIT"
          echo "Checking if app is installed..."
          xcrun simctl listapps "$DEVICE_ID" 2>/dev/null | grep -i "Internet" || true
          echo "Checking simulator status..."
          xcrun simctl list devices | grep -i booted || true
          # Exit code 4 often means the app crashed on launch - this IS a compatibility issue
          exit 1
        fi
        echo "✅ App appears to have launched"

  # Unit tests run on latest tvOS only
  test:
    name: Run Tests
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: |
        XCODE_PATH="/Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer"
        if [ ! -d "$XCODE_PATH" ]; then
          echo "Requested Xcode ${{ env.XCODE_VERSION }} not found. Available Xcode versions:"
          ls /Applications | grep Xcode || true
          exit 1
        fi
        sudo xcode-select -s "$XCODE_PATH"

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Install tvOS Simulator Runtime
      run: |
        # Check if tvOS simulator is available
        echo "Checking for tvOS simulators..."
        xcrun simctl list runtimes
        xcrun simctl list devices available | grep -i "tv" || echo "No tvOS devices found"

        # Install tvOS runtime if no tvOS simulators exist
        if ! xcrun simctl list runtimes | grep -q "tvOS"; then
          echo "Installing tvOS Simulator runtime..."
          xcodebuild -downloadPlatform tvOS
          echo "Verifying installation..."
          xcrun simctl list runtimes
          xcrun simctl list devices available | grep -i "tv"
        else
          echo "tvOS Simulator runtime already installed"
        fi

    - name: Cache SPM packages
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          .swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Boot simulator
      run: |
        # Pre-boot the simulator to avoid FrontBoard launch failures.
        DEVICE_ID=$(xcrun simctl list devices available | grep "Apple TV" | head -1 | grep -oE '[A-F0-9-]{36}')
        echo "Booting simulator: $DEVICE_ID"
        xcrun simctl boot "$DEVICE_ID" || true
        # Wait for simulator to fully boot
        sleep 10
        xcrun simctl list devices | grep -i "apple tv"

    - name: Run tests
      run: |
        # Run only unit tests, skip UI tests (they are flaky in CI and don't contribute to coverage).
        # Retry once if simulator fails to launch (FrontBoard intermittent issue).
        for attempt in 1 2; do
          echo "Test attempt $attempt..."
          rm -rf TestResults.xcresult
          if xcodebuild test \
            -project "Internet Archive.xcodeproj" \
            -scheme "Internet Archive" \
            -destination "platform=tvOS Simulator,name=Apple TV" \
            -only-testing:"Internet ArchiveTests" \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult; then
            echo "Tests passed on attempt $attempt"
            exit 0
          else
            echo "Tests failed on attempt $attempt"
            if [ $attempt -eq 1 ]; then
              echo "Retrying after simulator reset..."
              xcrun simctl shutdown all || true
              sleep 5
              DEVICE_ID=$(xcrun simctl list devices available | grep "Apple TV" | head -1 | grep -oE '[A-F0-9-]{36}')
              xcrun simctl boot "$DEVICE_ID" || true
              sleep 10
            fi
          fi
        done
        echo "Tests failed after 2 attempts"
        exit 1

    - name: Generate code coverage report
      if: success()
      run: |
        xcrun xccov view --report --json TestResults.xcresult > coverage.json
        echo "Code Coverage:"
        xcrun xccov view --report TestResults.xcresult

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: TestResults.xcresult

    - name: Upload coverage report
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.json

    - name: Check coverage threshold
      if: success()
      run: |
        # Get full coverage report
        REPORT=$(xcrun xccov view --report TestResults.xcresult)

        # Get app coverage line
        APP_LINE=$(echo "$REPORT" | grep -E '^Internet Archive\.app' | head -1)
        echo "Full app coverage: $APP_LINE"

        # Parse total and covered lines
        TOTAL_LINES=$(echo "$APP_LINE" | grep -oE '\([0-9]+/[0-9]+\)' | grep -oE '[0-9]+/[0-9]+' | cut -d'/' -f2)
        COVERED_LINES=$(echo "$APP_LINE" | grep -oE '\([0-9]+/[0-9]+\)' | grep -oE '[0-9]+/[0-9]+' | cut -d'/' -f1)

        # Validate extracted values
        if [ -z "$TOTAL_LINES" ] || [ -z "$COVERED_LINES" ]; then
          echo "❌ Error: Could not parse coverage data from report"
          echo "Report line: $APP_LINE"
          exit 1
        fi

        echo "Total lines: $TOTAL_LINES"
        echo "Covered lines: $COVERED_LINES"

        # Files to exclude (require Internet Archive API credentials to test)
        # NOTE: These files handle login/account/favorites functionality which cannot be tested
        # without valid API credentials. See Configuration.plist.template for setup.
        EXCLUDED_FILES="AccountVC.swift AccountNC.swift LoginVC.swift RegisterVC.swift PeopleVC.swift ItemVC.swift FavoriteVC.swift"

        EXCLUDED_TOTAL=0
        EXCLUDED_COVERED=0
        echo ""
        echo "=== Excluded files (require API credentials) ==="
        for file in $EXCLUDED_FILES; do
          FILE_LINE=$(echo "$REPORT" | grep "$file" | head -1)
          if [ -n "$FILE_LINE" ]; then
            FILE_TOTAL=$(echo "$FILE_LINE" | grep -oE '\([0-9]+/[0-9]+\)' | grep -oE '[0-9]+/[0-9]+' | cut -d'/' -f2)
            FILE_COVERED=$(echo "$FILE_LINE" | grep -oE '\([0-9]+/[0-9]+\)' | grep -oE '[0-9]+/[0-9]+' | cut -d'/' -f1)
            # Default to 0 if extraction failed
            FILE_TOTAL=${FILE_TOTAL:-0}
            FILE_COVERED=${FILE_COVERED:-0}
            echo "  $file: $FILE_TOTAL lines excluded"
            EXCLUDED_TOTAL=$((EXCLUDED_TOTAL + FILE_TOTAL))
            EXCLUDED_COVERED=$((EXCLUDED_COVERED + FILE_COVERED))
          fi
        done
        echo "Total excluded: $EXCLUDED_TOTAL lines"
        echo ""

        # Calculate adjusted coverage
        ADJUSTED_TOTAL=$((TOTAL_LINES - EXCLUDED_TOTAL))
        ADJUSTED_COVERED=$((COVERED_LINES - EXCLUDED_COVERED))

        # Validate adjusted total to avoid division by zero
        if [ "$ADJUSTED_TOTAL" -le 0 ]; then
          echo "Error: Adjusted total lines is $ADJUSTED_TOTAL (all lines excluded?)"
          exit 1
        fi

        ADJUSTED_COVERAGE=$(echo "scale=2; $ADJUSTED_COVERED * 100 / $ADJUSTED_TOTAL" | bc -l)

        echo "=== Adjusted Coverage (excluding API-dependent files) ==="
        echo "Adjusted total lines: $ADJUSTED_TOTAL"
        echo "Adjusted covered lines: $ADJUSTED_COVERED"
        echo "Adjusted coverage: ${ADJUSTED_COVERAGE}%"
        echo ""

        threshold=50
        if awk "BEGIN {exit !($ADJUSTED_COVERAGE < $threshold)}"; then
          echo "❌ Adjusted coverage ${ADJUSTED_COVERAGE}% is below threshold ${threshold}%"
          exit 1
        else
          echo "✅ Adjusted coverage ${ADJUSTED_COVERAGE}% meets threshold ${threshold}%"
        fi
